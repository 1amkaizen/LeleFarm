<!-- templates/dashboard/pengeluaran.html -->
{% extends "dashboard/base.html" %}
{% block title %}Pengeluaran{% endblock %}

{% block content %}


<!-- ===== PAGE HEADER + BREADCRUMB ===== -->
<div class="mb-8 mt-5">
  <!-- Breadcrumb -->
  <nav class="text-sm text-gray-500 mb-2">
    <ol class="flex items-center space-x-2">
      <li class="hover:text-blue-600 transition">
        <i class="fas fa-home mr-1"></i> Dashboard
      </li>
      <li>/</li>
      <li class="text-blue-700 font-semibold">
        Pengeluaran
      </li>
    </ol>
  </nav>

  <!-- Page Title -->
  <div class="flex items-center gap-4 
              bg-gradient-to-r from-blue-500 to-blue-600 
              text-white p-5 rounded-2xl shadow-lg">
    
    <!-- Icon -->
    <div class="bg-white/20 p-3 rounded-xl">
      <i class="fas fa-money-bill-wave text-2xl"></i>
    </div>

    <!-- Title -->
    <div>
      <h1 class="text-2xl font-bold leading-tight">
        Catat Pengeluaran
      </h1>
      <p class="text-sm text-blue-100">
        Pencatatan biaya operasional untuk monitoring keuangan
      </p>
    </div>
  </div>
</div>




{% if request.query_params.get("error") == "kolam_kosong" %}
<div class="mb-4 p-3 rounded bg-red-100 border border-red-300 text-red-700">
  ⚠️ Kolam belum dipilih atau belum ada.
  <br />
  Silakan buat kolam terlebih dahulu sebelum menambah bibit.
</div>
{% endif %}
<!-- Form Tambah Pengeluaran Baru -->
<form
  action="/dashboard/pengeluaran"
  method="post"
  class="space-y-5 bg-white/80 backdrop-blur-xl p-6 rounded-2xl shadow-xl
         border border-blue-100 mb-6 transition-all duration-300 hover:shadow-2xl"
>

  <h2 class="font-bold text-lg flex items-center gap-2 text-blue-700">
    <i class="fas fa-plus-circle text-blue-500"></i>
    Tambah Pengeluaran
  </h2>

  <!-- Pilih Kolam -->
  <div class="group">
    <label class="block mb-1 font-semibold text-blue-900 flex items-center gap-2">
      <i class="fas fa-water text-blue-500 group-focus-within:scale-110 transition"></i>
      Pilih Kolam
    </label>
    <select
      name="kolam_id"
      class="w-full rounded-xl border border-gray-300 bg-white px-4 py-2
             shadow-sm transition-all duration-300
             focus:border-blue-500 focus:ring-4 focus:ring-blue-200 focus:outline-none
             hover:border-blue-400"
    >
      <option value="">-- Pilih Kolam --</option>
      {% for kolam in kolam_list %}
        <option value="{{ kolam.id }}">{{ kolam.nama_kolam }}</option>
      {% endfor %}
    </select>
  </div>

  <!-- Nama Pengeluaran -->
  <div class="group">
    <label class="block mb-1 font-semibold text-blue-900 flex items-center gap-2">
      <i class="fas fa-tag text-blue-500 group-focus-within:scale-110 transition"></i>
      Nama Pengeluaran
    </label>
    <input
      type="text"
      name="nama"
      placeholder="Nama Pengeluaran"
      required
      class="w-full rounded-xl border border-gray-300 bg-white px-4 py-2
             shadow-sm transition-all duration-300
             focus:border-blue-500 focus:ring-4 focus:ring-blue-200 focus:outline-none
             hover:border-blue-400"
    />
  </div>

  <!-- Jumlah -->
  <div class="group">
    <label class="block mb-1 font-semibold text-blue-900 flex items-center gap-2">
      <i class="fas fa-sort-numeric-up text-indigo-500 group-focus-within:scale-110 transition"></i>
      Jumlah
    </label>
    <input
      type="text"
      name="jumlah"
      id="pengeluaran_jumlah"
      inputmode="numeric"
      value="1"
      required
      class="w-full rounded-xl border border-gray-300 bg-white px-4 py-2
             shadow-sm transition-all duration-300
             focus:border-indigo-500 focus:ring-4 focus:ring-indigo-200 focus:outline-none
             hover:border-indigo-400"
    />
  </div>

  <!-- Harga -->
  <div class="group">
    <label class="block mb-1 font-semibold text-blue-900 flex items-center gap-2">
      <i class="fas fa-coins text-yellow-500 group-focus-within:scale-110 transition"></i>
      Harga per Unit (Rp)
    </label>
    <input
      type="text"
      name="harga"
      id="pengeluaran_harga"
      inputmode="numeric"
      placeholder="Harga per Unit (Rp)"
      required
      class="w-full rounded-xl border border-gray-300 bg-white px-4 py-2
             shadow-sm transition-all duration-300
             focus:border-yellow-500 focus:ring-4 focus:ring-yellow-200 focus:outline-none
             hover:border-yellow-400"
    />
  </div>

  <!-- Tanggal -->
  <div class="group">
    <label class="block mb-1 font-semibold text-blue-900 flex items-center gap-2">
      <i class="fas fa-calendar-alt text-indigo-500 group-focus-within:scale-110 transition"></i>
      Tanggal
    </label>
    <input
      type="date"
      name="tanggal"
      required
      class="w-full rounded-xl border border-gray-300 bg-white px-4 py-2
             shadow-sm transition-all duration-300
             focus:border-indigo-500 focus:ring-4 focus:ring-indigo-200 focus:outline-none
             hover:border-indigo-400"
    />
  </div>

  <!-- Catatan -->
  <div class="group">
    <label class="block mb-1 font-semibold text-blue-900 flex items-center gap-2">
      <i class="fas fa-sticky-note text-gray-500 group-focus-within:scale-110 transition"></i>
      Catatan
    </label>
    <textarea
      name="catatan"
      placeholder="Catatan"
      rows="3"
      class="w-full rounded-xl border border-gray-300 bg-white px-4 py-2 resize-none
             shadow-sm transition-all duration-300
             focus:border-gray-500 focus:ring-4 focus:ring-gray-200 focus:outline-none
             hover:border-gray-400"
    ></textarea>
  </div>

  <!-- Button -->
  <button
    type="submit"
    class="w-full md:w-auto mt-3 px-6 py-3 rounded-xl font-semibold text-white
           bg-gradient-to-r from-blue-500 to-indigo-600
           shadow-lg transition-all duration-300
           hover:from-blue-600 hover:to-indigo-700
           hover:shadow-2xl hover:-translate-y-0.5
           active:translate-y-0
           flex items-center justify-center gap-2"
  >
    <i class="fas fa-save"></i>
    Simpan Pengeluaran
  </button>
</form>


<!-- Daftar Pengeluaran -->
<h2 class="text-xl font-semibold mb-2 flex items-center gap-2 text-blue-700">
  <i class="fas fa-list text-blue-500"></i> Daftar Pengeluaran
</h2>

<!-- Filter Per Kolam -->
<div class="mb-4">
  <label class="font-semibold text-blue-900 mr-2">Filter Kolam:</label>
  <select id="filterKolam" class="border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300">
    <option value="all">Semua Kolam</option>
    {% for kolam in kolam_list %}
    <option value="{{ kolam.id }}">{{ kolam.nama_kolam }}</option>
    {% endfor %}
  </select>
</div>


<div class="overflow-x-auto mb-5 rounded-2xl shadow-lg ring-1 ring-black/5 bg-white">
  <table
    class="w-full md:min-w-[900px] table-auto text-sm text-gray-700 text-center"
  >

    <!-- HEADER -->
    <thead class="bg-gradient-to-r from-blue-600 to-blue-500 text-white">
      <tr>
        <th class="px-4 py-3 font-semibold whitespace-nowrap">
          <i class="fas fa-hashtag mr-1"></i> ID
        </th>
        <th class="px-4 py-3 font-semibold whitespace-nowrap">
          <i class="fas fa-tag mr-1"></i> Nama
        </th>
        <th class="px-4 py-3 font-semibold whitespace-nowrap">
          <i class="fas fa-sort-numeric-up mr-1"></i> Jumlah
        </th>
        <th class="px-4 py-3 font-semibold whitespace-nowrap">
          <i class="fas fa-coins mr-1"></i> Harga/unit
        </th>
        <th class="px-4 py-3 font-semibold whitespace-nowrap">
          <i class="fas fa-money-bill-wave mr-1"></i> Total
        </th>
        <th class="px-4 py-3 font-semibold whitespace-nowrap">
          <i class="fas fa-calendar-alt mr-1"></i> Tanggal
        </th>
        <th class="px-4 py-3 font-semibold whitespace-nowrap">
          <i class="fas fa-water mr-1"></i> Kolam
        </th>
        <th class="px-4 py-3 font-semibold whitespace-nowrap">
          <i class="fas fa-sticky-note mr-1"></i> Catatan
        </th>
        <th class="px-4 py-3 font-semibold whitespace-nowrap text-center">
          <i class="fas fa-cogs mr-1"></i> Aksi
        </th>
      </tr>
    </thead>

    <!-- BODY -->
    <tbody class="divide-y divide-gray-100 bg-white">
      {% for pengeluaran in pengeluaran_list %}
      <tr class="pengeluaranRow hover:bg-blue-50/70 transition-all duration-200" data-kolam-id="{{ pengeluaran.kolam_id }}"
      >
        <td class="px-4 py-3 whitespace-nowrap font-medium">
          {{ pengeluaran.id }}
        </td>

        <td class="px-4 py-3 whitespace-nowrap font-semibold text-gray-800">
          {{ pengeluaran.nama_pengeluaran }}
        </td>

        <td class="px-4 py-3 whitespace-nowrap">
          {{ pengeluaran.jumlah }}
        </td>

        <td class="px-4 py-3 whitespace-nowrap">
          Rp {{ "{:,.0f}".format(pengeluaran.harga)|replace(',', '.') }}
        </td>

        <td class="px-4 py-3 whitespace-nowrap font-semibold text-blue-600">
          Rp {{ "{:,.0f}".format(pengeluaran.total)|replace(',', '.') }}
        </td>

        <td class="px-4 py-3 whitespace-nowrap">
          {{ pengeluaran.tanggal }}
        </td>

        <td class="px-4 py-3 whitespace-nowrap">
          {{ pengeluaran.nama_kolam or '-' }}
        </td>

        <td class="px-4 py-3 whitespace-nowrap text-gray-600 max-w-xs truncate">
          {{ pengeluaran.catatan or '-' }}
        </td>

        <!-- AKSI -->
        <td class="px-4 py-3 whitespace-nowrap">
          <div class="flex flex-nowrap items-center justify-center gap-2">

            <!-- Ubah tombol Edit -->
            <button
              class="inline-flex items-center justify-center gap-1.5 rounded-full px-3 py-1.5 text-xs font-semibold text-white transition
                     bg-yellow-400 hover:bg-yellow-500"
              onclick="PengeluaranTable.openEditModal({{ pengeluaran.id }}, '{{ pengeluaran.nama_pengeluaran }}', {{ pengeluaran.jumlah }}, {{ pengeluaran.harga }}, '{{ pengeluaran.tanggal }}', '{{ pengeluaran.catatan|default('') }}', '{{ pengeluaran.kolam_id or '' }}')"
            >
              <i class="fas fa-edit"></i>
            </button>

            <!-- Ubah tombol Delete -->
            <button
              class="inline-flex items-center justify-center gap-1.5 rounded-full px-3 py-1.5 text-xs font-semibold text-white transition
                     bg-red-500 hover:bg-red-600"
              onclick="PengeluaranTable.openDeleteModal({{ pengeluaran.id }})"
            >
              <i class="fas fa-trash-alt"></i>
            </button>

          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
    <!-- FOOTER TOTAL -->
    <tfoot class="bg-blue-50 font-semibold text-center">
      <tr>
        <!-- Kolom 1: ID -->
        <td class="px-4 py-3 text-left">
          <i class="fas fa-money-bill-wave text-yellow-500 mr-1"></i> Total
        </td>
    
        <!-- Kolom 2: Nama -->
        <td class="px-4 py-3"></td>
    
        <!-- Kolom 3: Jumlah -->
        <td class="px-4 py-3 whitespace-nowrap font-bold" id="totalJumlahCell">
          {{ total_jumlah }}
        </td>
    
        <!-- Kolom 4: Harga/unit -->
        <td class="px-4 py-3"></td>
    
        <!-- Kolom 5: Total -->
        <td class="px-4 py-3 whitespace-nowrap font-bold text-blue-600" id="grandTotalCell">
          Rp {{ "{:,.0f}".format(grand_total)|replace(',', '.') }}
        </td>
    
        <!-- Kolom 6: Tanggal -->
        <td class="px-4 py-3"></td>
    
        <!-- Kolom 7: Kolam -->
        <td class="px-4 py-3"></td>
    
        <!-- Kolom 8: Catatan -->
        <td class="px-4 py-3"></td>
    
        <!-- Kolom 9: Aksi -->
        <td class="px-4 py-3"></td>
      </tr>
    </tfoot>
    
    
  </table>
</div>


<!-- Pagination Controls -->
<div id="paginationControls" class="flex items-center justify-center gap-3 mt-6 mb-6">

  <button id="prevBtn" onclick="PengeluaranTable.changePage('prev')" disabled>
    <i class="fas fa-chevron-left text-sm"></i>
  </button>

  <span
    id="pageInfo"
    class="px-5 py-2 rounded-full bg-blue-100 text-blue-800
           font-semibold text-sm shadow-inner">
    Page 1
  </span>

  <button id="nextBtn" onclick="PengeluaranTable.changePage('next')" disabled>
    <i class="fas fa-chevron-right text-sm"></i>
  </button>

</div>



<!-- Modal Edit Pengeluaran -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <h2 class="text-lg font-semibold text-blue-700 mb-4">Edit Pengeluaran</h2>
    <form id="editForm" method="post" action="/dashboard/pengeluaran/edit">
      <input type="hidden" name="pengeluaran_id" id="edit_id" />
      <div class="mb-3">
        <label class="block text-sm font-medium text-blue-900">Pilih Kolam</label>
        <select id="edit_kolam" name="kolam_id" class="border rounded p-2 w-full focus:ring-2 focus:ring-blue-300">
          <option value="">-- Pilih Kolam --</option>
          {% for kolam in kolam_list %}
            <option value="{{ kolam.id }}">{{ kolam.nama_kolam }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-blue-900">Nama Pengeluaran</label>
        <input type="text" id="edit_nama" name="nama" class="border rounded p-2 w-full focus:ring-2 focus:ring-blue-300" required />
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-blue-900">Jumlah</label>
        <input type="number" id="edit_jumlah" name="jumlah" class="border rounded p-2 w-full focus:ring-2 focus:ring-blue-300" required />
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-blue-900">Harga per Unit (Rp)</label>
        <input type="number" id="edit_harga" name="harga" class="border rounded p-2 w-full focus:ring-2 focus:ring-blue-300" required />
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-blue-900">Tanggal</label>
        <input type="date" id="edit_tanggal" name="tanggal" class="border rounded p-2 w-full focus:ring-2 focus:ring-blue-300" required />
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium text-blue-900">Catatan</label>
        <textarea id="edit_catatan" name="catatan" class="border rounded p-2 w-full focus:ring-2 focus:ring-blue-300"></textarea>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="PengeluaranTable.closeEditModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Batal</button>

        <button type="submit" class="px-4 py-2 rounded bg-blue-500 hover:bg-blue-600 text-white">Simpan</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Delete Pengeluaran -->
<div
  id="deleteModal"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
>
  <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6 relative">
    <h2 class="text-lg font-semibold text-blue-900 mb-4">Hapus Pengeluaran?</h2>
    <form id="deleteForm" method="post" action="/dashboard/pengeluaran/delete">
      <input type="hidden" name="pengeluaran_id" id="delete_id" />
      <div class="flex justify-end gap-2">
        <!-- tombol batal di modal -->
        <button type="button" onclick="PengeluaranTable.closeDeleteModal()"
                class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">
          Batal
        </button>
        
        <button
          type="submit"
          class="px-4 py-2 rounded bg-red-500 hover:bg-red-600 text-white"
        >
          Hapus
        </button>
      </div>
    </form>
  </div>
</div>


<script>
  const PengeluaranTable = (() => {
    // ======== Variabel ========
    const rowsPerPage = 5;
    let currentPage = 1;
    const allRows = Array.from(document.querySelectorAll('.pengeluaranRow'));
    let filteredRows = allRows.slice(); // awalnya semua row
    const totalRow = document.querySelector("tfoot tr");
  
    const filterSelect = document.getElementById('filterKolam'); // optional kalau mau filter kolam
  
    // ======== Modal ========
    function openEditModal(id, nama, jumlah, harga, tanggal, catatan, kolam_id) {
      document.getElementById('edit_id').value = id;
      document.getElementById('edit_nama').value = nama;
      document.getElementById('edit_jumlah').value = jumlah;
      document.getElementById('edit_harga').value = harga;
      document.getElementById('edit_tanggal').value = tanggal;
      document.getElementById('edit_catatan').value = catatan;
      document.getElementById('edit_kolam').value = kolam_id;
      document.getElementById('editModal').classList.remove('hidden');
    }
  
    function closeEditModal() {
      document.getElementById('editModal').classList.add('hidden');
    }
  
    function openDeleteModal(id) {
      document.getElementById('delete_id').value = id;
      document.getElementById('deleteModal').classList.remove('hidden');
    }
  
    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.add('hidden');
    }
  
    // ======== Format Input ========
    function formatRibuan(value) {
      return value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }
  
    function angkaMurni(value) {
      return value.replace(/\./g, '');
    }
  
    function handleInputRibuan(input) {
      input.addEventListener('input', () => {
        let value = input.value.replace(/\D/g, '');
        input.value = value ? formatRibuan(value) : '';
      });
    }
  
    const form = document.querySelector('form[action="/dashboard/pengeluaran"]');
    const jumlahInput = document.getElementById('pengeluaran_jumlah');
    const hargaInput = document.getElementById('pengeluaran_harga');
  
    handleInputRibuan(jumlahInput);
    handleInputRibuan(hargaInput);
  
    form.addEventListener('submit', () => {
      jumlahInput.value = angkaMurni(jumlahInput.value);
      hargaInput.value = angkaMurni(hargaInput.value);
    });
  
    // ======== Pagination & Filter ========
    function updateTotals() {
      let totalJumlah = 0;
      let totalHarga = 0;
    
      filteredRows.forEach(row => {
        const jumlahText = row.children[2].innerText.replace(/\./g, '').trim();
        const totalText = row.children[4].innerText.replace(/\D/g, '').trim();
    
        totalJumlah += parseInt(jumlahText) || 0;
        totalHarga += parseInt(totalText) || 0;
      });
    
      if (totalRow) {
        totalRow.children[0].innerText = 'Total'; // ID kolom
        totalRow.children[1].innerText = '';      // Nama
        totalRow.children[2].innerText = totalJumlah.toLocaleString('id-ID'); // Jumlah
        totalRow.children[3].innerText = '';      // Harga/unit
        totalRow.children[4].innerText = 'Rp ' + totalHarga.toLocaleString('id-ID'); // Total
        totalRow.children[5].innerText = '';      // Tanggal
        totalRow.children[6].innerText = '';      // Kolam
        totalRow.children[7].innerText = '';      // Catatan
        totalRow.children[8].innerText = '';      // Aksi
      }
    }
    
    
  
    function showPage(page) {
      const startIdx = (page - 1) * rowsPerPage;
      const endIdx = startIdx + rowsPerPage;
  
      allRows.forEach(row => row.style.display = 'none');
      filteredRows.forEach((row, index) => {
        if (index >= startIdx && index < endIdx) row.style.display = '';
      });
  
      const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
      document.getElementById('pageInfo').innerText = `Page ${page} of ${totalPages || 1}`;
      document.getElementById('prevBtn').disabled = page === 1;
      document.getElementById('nextBtn').disabled = page === totalPages || totalPages === 0;
  
      updateTotals();
    }
  
    function changePage(direction) {
      if (direction === 'prev' && currentPage > 1) currentPage--;
      else if (direction === 'next' && currentPage < Math.ceil(filteredRows.length / rowsPerPage)) currentPage++;
      showPage(currentPage);
    }
  
    if (filterSelect) {
      filterSelect.addEventListener('change', () => {
        const selectedKolam = filterSelect.value;
        filteredRows = allRows.filter(row => selectedKolam === 'all' || row.dataset.kolamId === selectedKolam);
        currentPage = 1;
        showPage(currentPage);
      });
    }
  
    // ======== Default tanggal ========
    document.addEventListener('DOMContentLoaded', () => {
      const tanggalInput = document.querySelector('input[name="tanggal"]');
      if (tanggalInput && !tanggalInput.value) {
        const today = new Date();
        tanggalInput.value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      }
  
      const editTanggal = document.getElementById('edit_tanggal');
      if (editTanggal && !editTanggal.value) {
        const today = new Date();
        editTanggal.value = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      }
  
      showPage(currentPage);
    });
  
    return { openEditModal, closeEditModal, openDeleteModal, closeDeleteModal, changePage };
  })();
  </script>
  
{% endblock %}
