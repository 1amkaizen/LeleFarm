<!-- templates/dashboard/kematian.html -->
{% extends "dashboard/base.html" %}
{% block title %}Kematian Lele{% endblock %}

{% block content %}


<!-- ===== PAGE HEADER + BREADCRUMB ===== -->
<div class="mb-8 mt-5">
  <!-- Breadcrumb -->
  <nav class="text-sm text-gray-500 mb-2">
    <ol class="flex items-center space-x-2">
      <li class="hover:text-red-600 transition">
        <i class="fas fa-home mr-1"></i> Dashboard
      </li>
      <li>/</li>
      <li class="text-red-700 font-semibold">
        Kematian
      </li>
    </ol>
  </nav>

  <!-- Page Title -->
  <div class="flex items-center gap-4 
              bg-gradient-to-r from-red-500 to-rose-600
              text-white p-5 rounded-2xl shadow-lg">
    
    <!-- Icon -->
    <div class="bg-white/20 p-3 rounded-xl">
      <i class="fas fa-skull-crossbones text-2xl"></i>
    </div>

    <!-- Title -->
    <div>
      <h1 class="text-2xl font-bold leading-tight">
        Kematian
      </h1>
      <p class="text-sm text-red-100">
        Catat Kematian Lele
      </p>
    </div>
  </div>
</div>



{% if request.query_params.get("error") == "kolam_kosong" %}
<div class="mb-4 p-3 rounded bg-red-100 border border-red-300 text-red-700">
  ⚠️ Kolam belum dipilih atau belum ada.<br />
  Silakan buat kolam terlebih dahulu sebelum menambah stok pakan.
</div>
{% endif %}

<!-- Form Kematian Baru -->
<form action="/dashboard/kematian" method="post" x-data="{ open: false, selected: null }" class="bg-white/90 backdrop-blur-2xl p-8 rounded-3xl shadow-[0_20px_50px_rgba(239,_68,_68,_0.1)] border border-red-50 mb-8
         transition-all duration-500 hover:shadow-[0_30px_60px_rgba(239,_68,_68,_0.15)]">

  <div class="flex items-center gap-3 mb-6">
    <div class="h-8 w-1.5 bg-red-600 rounded-full shadow-[0_0_10px_rgba(220,_38,_38,_0.5)]"></div>
    <h2 class="text-xl font-bold text-gray-800 tracking-tight">Catat Kematian Lele</h2>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

    <div class="relative group lg:col-span-2">
      <label class="flex items-center gap-2 mb-2 ml-1 text-sm font-bold text-red-900 uppercase tracking-wider">
        <i class="fas fa-water text-red-500"></i>
        Lokasi Kolam
      </label>
      <div class="w-full rounded-2xl border border-gray-200 bg-gray-50/50 px-5 py-3.5 cursor-pointer
               shadow-inner transition-all duration-300 flex justify-between items-center
               hover:border-red-300 focus-within:ring-4 focus-within:ring-red-100" @click="open = !open">
        <span class="font-medium text-gray-700" x-text="selected ? selected.nama : 'Pilih kolam lele...'"></span>
        <i class="fas fa-chevron-down text-gray-400 transition-transform duration-300"
          :class="open && 'rotate-180'"></i>
      </div>

      <ul x-show="open" x-transition:enter="transition ease-out duration-100"
        x-transition:enter-start="opacity-0 scale-95" x-transition:leave="transition ease-in duration-75"
        @click.outside="open = false" class="absolute left-0 w-full mt-2 bg-white/95 backdrop-blur-xl rounded-2xl border border-red-50
                 max-h-52 overflow-auto z-[60] shadow-2xl p-2 space-y-1">
        {% for kolam in kolam_list %}
        <li class="px-4 py-2.5 rounded-xl cursor-pointer transition-all duration-200
                   hover:bg-red-600 hover:text-white font-medium flex items-center justify-between group/item"
          @click="selected = {id: {{ kolam.id }}, nama: '{{ kolam.nama_kolam }}'}; open=false;">
          {{ kolam.nama_kolam }}
          <i class="fas fa-arrow-right opacity-0 group-hover/item:opacity-100 transition-opacity"></i>
        </li>
        {% endfor %}
      </ul>
      <input type="hidden" name="kolam_id" :value="selected ? selected.id : ''" required />
    </div>

    <div class="relative group">
      <label for="tanggal"
        class="flex items-center gap-2 mb-2 ml-1 text-sm font-bold text-red-900 uppercase tracking-wider">
        <i class="fas fa-calendar-day text-red-500"></i>
        Tanggal
      </label>
      <input type="date" id="tanggal" name="tanggal" required class="w-full rounded-2xl border-gray-200 bg-gray-50/50 px-5 py-3.5
               shadow-inner transition-all duration-300 cursor-pointer
               focus:bg-white focus:border-red-500 focus:ring-4 focus:ring-red-100 focus:outline-none" />
    </div>

    <div class="relative group">
      <label for="jumlah"
        class="flex items-center gap-2 mb-2 ml-1 text-sm font-bold text-red-700 uppercase tracking-wider">
        <i class="fas fa-skull-crossbones text-red-600"></i>
        Jumlah (Ekor)
      </label>
      <input type="number" id="jumlah" name="jumlah" min="1" required placeholder="0" class="w-full rounded-2xl border-gray-200 bg-gray-50/50 px-5 py-3.5
               shadow-inner transition-all duration-300 font-bold text-red-600
               focus:bg-white focus:border-red-600 focus:ring-4 focus:ring-red-100 focus:outline-none" />
    </div>

    <div class="relative group lg:col-span-4">
      <label for="catatan"
        class="flex items-center gap-2 mb-2 ml-1 text-sm font-bold text-gray-700 uppercase tracking-wider">
        <i class="fas fa-sticky-note text-gray-400"></i>
        Penyebab / Keterangan
      </label>
      <textarea id="catatan" name="catatan" rows="1" placeholder="Misal: Perubahan suhu ekstrem atau PH drop..." class="w-full rounded-2xl border-gray-200 bg-gray-50/50 px-5 py-3.5 resize-none
               shadow-inner transition-all duration-300 min-h-[54px]
               focus:bg-white focus:border-red-400 focus:ring-4 focus:ring-red-50 focus:outline-none"></textarea>
    </div>

  </div>

  <div class="mt-8 flex flex-col md:flex-row justify-between items-center gap-4">
    <div
      class="flex items-center gap-2 text-red-600 bg-red-50 px-4 py-2 rounded-full text-xs font-bold uppercase tracking-tighter">
      <i class="fas fa-exclamation-triangle animate-pulse"></i>
      Data kematian akan mengurangi stok bibit secara otomatis
    </div>

    <button type="submit" class="group w-full md:w-auto px-10 py-4 rounded-2xl font-bold text-white
             bg-red-600 shadow-[0_10px_20px_rgba(220,_38,_38,_0.3)] transition-all duration-300
             hover:bg-red-700 hover:-translate-y-1 active:scale-95
             flex items-center justify-center gap-3">
      <i class="fas fa-save text-lg group-hover:shake"></i>
      Simpan Laporan
    </button>
  </div>
</form>
<h2 class="text-xl font-semibold mb-2 flex items-center gap-2 text-red-700"><i class="fas fa-list text-red-500"></i> Riwayat Kematian</h2>
<!-- Filter Per Kolam -->
<div class="mb-4">
  <label class="font-semibold text-blue-900 mr-2">Filter Kolam:</label>
  <select id="filterKolam" class="border rounded px-3 py-2 focus:ring-2 focus:ring-blue-300">
    <option value="all">Semua Kolam</option>
    {% for kolam in kolam_list %}
    <option value="{{ kolam.id }}">{{ kolam.nama_kolam }}</option>
    {% endfor %}
  </select>
</div>

<div class="overflow-x-auto mb-5 rounded-2xl shadow-lg ring-1 ring-black/5 bg-white">
  <table
    class="w-full md:min-w-[700px] table-auto text-sm text-gray-700 text-center"
  >

    <!-- HEADER -->
    <thead class="bg-gradient-to-r from-red-500 to-red-400 text-white">
      <tr>
        <th class="px-4 py-3 font-semibold whitespace-nowrap">
          <i class="fas fa-calendar-alt"></i> Tanggal
        </th>
        <th class="px-4 py-3 font-semibold whitespace-nowrap">
          <i class="fas fa-water"></i> Kolam
        </th>
        <th class="px-4 py-3 font-semibold whitespace-nowrap">
          <i class="fas fa-skull-crossbones"></i> Jumlah
        </th>
        <th class="px-4 py-3 font-semibold whitespace-nowrap">
          <i class="fas fa-sticky-note"></i> Catatan
        </th>
        <th class="px-4 py-3 font-semibold whitespace-nowrap">
          <i class="fas fa-cogs"></i> Aksi
        </th>
      </tr>
    </thead>

    <!-- BODY -->
    <tbody class="divide-y divide-gray-100 bg-white">
      {% for item in kematian_list %}
      <tr class="kematianRow hover:bg-red-50/70 transition-all duration-200" data-kolam-id="{{ item.kolam_id }}"
      >

        <td class="px-4 py-3 whitespace-nowrap">
          {{ item["tanggal"] }}
        </td>

        <td class="px-4 py-3 whitespace-nowrap font-medium">
          {% for kolam in kolam_list %}
            {% if kolam["id"] == item["kolam_id"] %}
              {{ kolam["nama_kolam"] }}
            {% endif %}
          {% endfor %}
        </td>

        <td class="px-4 py-3 whitespace-nowrap font-semibold text-red-600">
          {{ "{:,}".format(item["jumlah"]).replace(",", ".") }}
        </td>

        <td class="px-4 py-3 whitespace-nowrap text-gray-600">
          {{ item["catatan"] or '-' }}
        </td>

        <!-- AKSI -->
        <td class="px-4 py-3 whitespace-nowrap">
          <div class="flex justify-center gap-2">
            <button
              type="button"
              class="inline-flex items-center justify-center gap-1.5 rounded-full px-3 py-1.5 text-xs font-semibold text-white transition
                     bg-yellow-400 hover:bg-yellow-500"
              onclick="openEditModal(
                {{ item['id'] }},
                {{ item['kolam_id'] }},
                '{{ item['tanggal'] }}',
                {{ item['jumlah'] }},
                '{{ item['catatan']|default('') }}'
              )"
            >
              <i class="fas fa-edit"></i>
            </button>

            <button
              type="button"
              class="inline-flex items-center justify-center gap-1.5 rounded-full px-3 py-1.5 text-xs font-semibold text-white transition
                     bg-red-500 hover:bg-red-600"
              onclick="openDeleteModal({{ item['id'] }})"
            >
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        </td>

      </tr>
      {% endfor %}
    </tbody>

    <!-- FOOTER -->
    <tfoot class="bg-blue-50 font-semibold text-center">
      <tr>
        <td class="px-4 py-3 whitespace-nowrap" colspan="2">
          <i class="fas fa-weight-hanging text-yellow-500 mr-1"></i> Total Kematian
        </td>
    
        <!-- Kolom Jumlah -->
        <td class="px-4 py-3 whitespace-nowrap font-bold text-red-600" id="totalKematianCell">
          0
        </td>
    
        <!-- Kolom Catatan -->
        <td class="px-4 py-3"></td>
    
        <!-- Kolom Aksi -->
        <td class="px-4 py-3"></td>
      </tr>
    </tfoot>
    


  </table>
</div>


<!-- Pagination Controls -->
<div id="paginationControls" class="flex items-center justify-center gap-3 mt-6 mb-6">

  <button
    id="prevBtn"
    onclick="changePage('prev')"
    disabled
    class="flex items-center justify-center w-11 h-11 rounded-full
           bg-white border border-red-300 text-red-600
           hover:bg-red-600 hover:text-white
           shadow-md transition-all duration-200
           disabled:opacity-40 disabled:cursor-not-allowed">
    <i class="fas fa-chevron-left text-sm"></i>
  </button>

  <span
    id="pageInfo"
    class="px-5 py-2 rounded-full bg-red-100 text-red-800
           font-semibold text-sm shadow-inner">
    Page 1
  </span>

  <button
    id="nextBtn"
    onclick="changePage('next')"
    disabled
    class="flex items-center justify-center w-11 h-11 rounded-full
           bg-white border border-red-300 text-red-600
           hover:bg-red-600 hover:text-white
           shadow-md transition-all duration-200
           disabled:opacity-40 disabled:cursor-not-allowed">
    <i class="fas fa-chevron-right text-sm"></i>
  </button>

</div>


<!-- Modal Edit Kematian -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <h2 class="text-lg font-semibold text-red-700 mb-4">Edit Kematian</h2>
    <form id="editForm" method="post" action="/dashboard/kematian/edit">
      <input type="hidden" name="kematian_id" id="edit_id" />
      <div class="mb-3">
        <label class="block font-medium text-red-900">Kolam</label>
        <select id="edit_kolam" name="kolam_id" class="border rounded p-2 w-full focus:ring-2 focus:ring-red-300">
          {% for kolam in kolam_list %}
          <option value="{{ kolam.id }}">{{ kolam.nama_kolam }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-3">
        <label class="block font-medium text-red-900">Tanggal</label>
        <input type="date" id="edit_tanggal" name="tanggal" class="border rounded p-2 w-full focus:ring-2 focus:ring-red-300" />
      </div>
      <div class="mb-3">
        <label class="block font-medium text-red-700">Jumlah</label>
        <input type="number" id="edit_jumlah" name="jumlah" min="1" class="border rounded p-2 w-full focus:ring-2 focus:ring-red-300" />
      </div>
      <div class="mb-3">
        <label class="block font-medium text-red-900">Catatan</label>
        <textarea id="edit_catatan" name="catatan" class="border rounded p-2 w-full focus:ring-2 focus:ring-red-300"></textarea>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeEditModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Batal</button>
        <button type="submit" class="px-4 py-2 rounded bg-red-500 hover:bg-red-600 text-white">Simpan</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Delete Kematian -->
<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6 relative">
    <h2 class="text-lg font-semibold text-red-700 mb-4">Hapus Kematian?</h2>
    <form id="deleteForm" method="post" action="/dashboard/kematian/delete">
      <input type="hidden" name="kematian_id" id="delete_id" />
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeDeleteModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Batal</button>
        <button type="submit" class="px-4 py-2 rounded bg-red-500 hover:bg-red-600 text-white">Hapus</button>
      </div>
    </form>
  </div>
</div>

<script>
  const KematianTable = (() => {
    // ======== Variabel ========
    const rowsPerPage = 5;
    let currentPage = 1;
    const allRows = Array.from(document.querySelectorAll('.kematianRow'));
    let filteredRows = allRows.slice(); // awalnya semua row
    const totalRowCell = document.getElementById('totalKematianCell');
    const filterSelect = document.getElementById('filterKolam');

    // ======== Modal ========
    function openEditModal(id, kolam_id, tanggal, jumlah, catatan) {
      document.getElementById('edit_id').value = id;
      document.getElementById('edit_kolam').value = kolam_id;
      document.getElementById('edit_tanggal').value = tanggal;
      document.getElementById('edit_jumlah').value = jumlah;
      document.getElementById('edit_catatan').value = catatan;
      document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.add('hidden');
    }

    function openDeleteModal(id) {
      document.getElementById('delete_id').value = id;
      document.getElementById('deleteModal').classList.remove('hidden');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.add('hidden');
    }

    // ======== Update Total Kematian ========
    function updateTotals() {
      let totalKematian = 0;
      filteredRows.forEach(row => {
        const jumlahText = row.children[2].innerText.replace(/\./g,'').trim();
        totalKematian += parseInt(jumlahText) || 0;
      });
      if(totalRowCell){
        totalRowCell.innerText = totalKematian.toLocaleString('id-ID');
      }
    }

    // ======== Pagination ========
    function showPage(page) {
      const startIdx = (page - 1) * rowsPerPage;
      const endIdx = startIdx + rowsPerPage;

      allRows.forEach(row => row.style.display = 'none');
      filteredRows.forEach((row, index) => {
        if (index >= startIdx && index < endIdx) row.style.display = '';
      });

      const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
      document.getElementById('pageInfo').innerText = `Page ${page} of ${totalPages || 1}`;
      document.getElementById('prevBtn').disabled = page === 1;
      document.getElementById('nextBtn').disabled = page === totalPages || totalPages === 0;

      updateTotals();
    }

    function changePage(direction) {
      const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
      if (direction === 'prev' && currentPage > 1) currentPage--;
      else if (direction === 'next' && currentPage < totalPages) currentPage++;
      showPage(currentPage);
    }

    // ======== Filter Kolam ========
    if(filterSelect){
      filterSelect.addEventListener('change', () => {
        const selectedKolam = filterSelect.value;
        filteredRows = allRows.filter(row => selectedKolam === 'all' || row.dataset.kolamId === selectedKolam);
        currentPage = 1;
        showPage(currentPage);
      });
    }

    // ======== Default load ========
    document.addEventListener('DOMContentLoaded', () => {
      showPage(currentPage);
    });

    // ======== Expose ke global supaya pagination tombol bisa dipakai ========
    window.changePage = changePage;
    window.openEditModal = openEditModal;
    window.closeEditModal = closeEditModal;
    window.openDeleteModal = openDeleteModal;
    window.closeDeleteModal = closeDeleteModal;

    return { openEditModal, closeEditModal, openDeleteModal, closeDeleteModal, changePage };
  })();
</script>

{% endblock %}
