<!-- templates/dashboard/bibit.html -->
{% extends "dashboard/base.html" %} {% block title %}Kelola Bibit{% endblock %}
{% block content %}
<!-- Breadcrumb / Page title -->
<div class="mb-6 flex items-center gap-2 mt-5">
  <i class="fas fa-fish text-indigo-500 text-xl"></i>
  <div>
    <h1 class="text-2xl font-semibold text-blue-900 leading-tight">
      {% block page_title %}Kelola Bibit{% endblock %}
    </h1>
    <p class="text-sm text-blue-700 mt-0.5">
      {% block page_subtitle %}Kelola dan pantau data bibit lele di setiap
      kolam{% endblock %}
    </p>
  </div>
</div>

<!-- Form Tambah Bibit Baru -->
<form
  action="/dashboard/bibit"
  method="post"
  class="space-y-4 border bg-white p-4 rounded-lg shadow mb-6"
>
  <div class="relative w-full" x-data="{ open: false, selected: null }">
    <label class="block font-medium mb-1 text-blue-900">
      <i class="fas fa-water text-blue-500"></i> Pilih Kolam
    </label>
    <div
      class="border rounded w-full p-2 cursor-pointer focus:ring-2 focus:ring-blue-300"
      @click="open = !open"
    >
      <span x-text="selected ? selected.nama : 'Pilih kolam...'"></span>
      <i class="fas fa-chevron-down float-right"></i>
    </div>
    <ul
      x-show="open"
      @click.outside="open = false"
      class="absolute left-0 w-full bg-white border rounded mt-1 max-h-48 overflow-auto z-50 shadow"
    >
      {% for kolam in kolam_list %}
      <li
        class="px-3 py-2 hover:bg-blue-50 cursor-pointer"
        @click="selected = {id: {{ kolam.id }}, nama: '{{ kolam.nama_kolam }}'}; open=false;"
      >
        {{ kolam.nama_kolam }}
      </li>
      {% endfor %}
    </ul>
    <input type="hidden" name="kolam_id" :value="selected ? selected.id : ''" />
  </div>

  <!-- Input Ukuran Bibit Baru -->
  <div>
    <label for="ukuran_bibit" class="block font-medium text-blue-900">
      <i class="fas fa-ruler-combined text-yellow-500"></i> Ukuran Bibit
    </label>
    <select
      name="ukuran_bibit"
      id="ukuran_bibit"
      class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-300"
      required
    >
      <option value="" disabled selected>Pilih ukuran...</option>
      {% for ukuran in ukuran_list %}
      <option value="{{ ukuran }}">{{ ukuran }}</option>
      {% endfor %}
    </select>
  </div>

  <div>
    <label for="jumlah" class="block font-medium text-blue-900">
      <i class="fas fa-sort-numeric-up text-green-500"></i> Jumlah Bibit
    </label>
    <input
      type="text"
      name="jumlah"
      id="jumlah"
      inputmode="numeric"
      class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-300"
      placeholder="Jumlah ekor"
      required
    />
  </div>

  <div>
    <label for="total_berat" class="block font-medium text-blue-900">
      <i class="fas fa-weight-hanging text-yellow-500"></i> Total Berat (kg)
    </label>
    <input
      type="text"
      name="total_berat"
      id="total_berat"
      inputmode="decimal"
      class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-300"
      placeholder="Total Berat (kg)"
    />
  </div>

  <div>
    <label for="total_harga" class="block font-medium text-blue-900">
      <i class="fas fa-coins text-yellow-500"></i> Total Harga (optional)
    </label>
    <input
      type="text"
      name="total_harga"
      id="total_harga"
      inputmode="numeric"
      class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-300"
      placeholder="0"
    />
  </div>

  <div>
    <label for="tanggal_tebar" class="block font-medium text-blue-900">
      <i class="fas fa-calendar-alt text-indigo-500"></i> Tanggal Tebar
      (optional)
    </label>
    <input
      type="date"
      name="tanggal_tebar"
      id="tanggal_tebar"
      class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-300"
    />
  </div>

  <div>
    <label for="catatan" class="block font-medium text-blue-900">
      <i class="fas fa-sticky-note text-gray-500"></i> Catatan (optional)
    </label>
    <textarea
      name="catatan"
      id="catatan"
      class="border p-2 rounded w-full focus:ring-2 focus:ring-blue-300"
      rows="2"
    ></textarea>
  </div>

  <button
    type="submit"
    class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded flex items-center gap-2 transition"
  >
    <i class="fas fa-plus-circle"></i> Tambah Bibit
  </button>
</form>

<!-- Ringkasan Total Bibit -->
<hr class="my-6" />
<h2 class="text-xl font-semibold mb-2 flex items-center gap-2 text-blue-900">
  <i class="fas fa-list text-indigo-500"></i> Daftar Bibit
</h2>

<div class="overflow-x-auto mb-5">
  <table
    class="table-auto w-full md:min-w-[900px] border-collapse border bg-white shadow rounded-lg overflow-hidden"
  >
    <thead class="bg-blue-100 text-blue-700 text-center font-semibold">
      <tr>
        <th class="border px-2 py-1 whitespace-nowrap">ID</th>
        <th class="border px-2 py-1 whitespace-nowrap">
          <i class="fas fa-water"></i> Kolam
        </th>
        <th class="border px-2 py-1 whitespace-nowrap">
          <i class="fas fa-calendar-alt"></i> Tanggal Tebar
        </th>
        <th class="border px-2 py-1 whitespace-nowrap">
          <i class="fas fa-ruler-combined"></i> Ukuran
        </th>
        <th class="border px-2 py-1 whitespace-nowrap">
          <i class="fas fa-sort-numeric-up"></i> Jumlah
        </th>
        <th class="border px-2 py-1 whitespace-nowrap">
          <i class="fas fa-weight-hanging"></i> Total Berat (kg)
        </th>
        <th class="border px-2 py-1 whitespace-nowrap">
          <i class="fas fa-coins"></i> Total Harga
        </th>
        <th class="border px-2 py-1 whitespace-nowrap">
          <i class="fas fa-sticky-note"></i> Catatan
        </th>
        <th class="border px-2 py-1 whitespace-nowrap">
          <i class="fas fa-cogs"></i> Aksi
        </th>
      </tr>
    </thead>
    <tbody class="text-center divide-y divide-gray-200">
      {% for bibit in bibit_list %}
      <tr class="hover:bg-blue-50 transition">
        <td class="border px-2 py-1 whitespace-nowrap">{{ bibit.id }}</td>
        <td class="border px-2 py-1 whitespace-nowrap">
          {{ bibit.nama_kolam }}
        </td>
        <td class="border px-2 py-1 whitespace-nowrap">
          {{ bibit.tanggal_tebar or '-' }}
        </td>
        <td class="border px-2 py-1 whitespace-nowrap">
          {{ bibit.ukuran_bibit }}
        </td>
        <td class="border px-2 py-1 whitespace-nowrap">
          {{ "{:,}".format(bibit.jumlah).replace(',', '.') }}
        </td>
        <td class="border px-2 py-1 whitespace-nowrap">
          {{ "{:,}".format(bibit.total_berat or 0).split('.')[0].replace(',',
          '.') }}
        </td>
        <td class="border px-2 py-1 whitespace-nowrap">
          Rp {{ "{:,.0f}".format(bibit.total_harga or 0).replace(',', '.') }}
        </td>
        <td class="border px-2 py-1 whitespace-nowrap">
          {{ bibit.catatan or '-' }}
        </td>
        <td class="border px-2 py-1 whitespace-nowrap">
          <div class="flex flex-wrap justify-center gap-1">
            <button
              class="bg-yellow-400 hover:bg-yellow-500 text-white text-sm md:text-base px-2 py-1 md:px-3 md:py-1.5 rounded flex items-center gap-1 transition"
              onclick="openEditModal({{ bibit.id }}, {{ bibit.kolam_id }}, '{{ bibit.ukuran_bibit }}', {{ bibit.jumlah }}, {{ bibit.total_harga }}, '{{ bibit.tanggal_tebar or '' }}', '{{ bibit.catatan or '' }}', {{ bibit.total_berat }})"
            >
              <i class="fas fa-edit"></i>
            </button>
            <button
              type="button"
              class="bg-red-500 hover:bg-red-600 text-white text-sm md:text-base px-2 py-1 md:px-3 md:py-1.5 rounded flex items-center gap-1 transition"
              onclick="openDeleteModal({{ bibit.id }})"
            >
              <i class="fas fa-trash-alt"></i>
            </button>
          </div>
        </td>
      </tr>
      {% endfor %}
      <tr class="font-semibold bg-blue-100">
        <td class="border px-2 py-1 whitespace-nowrap" colspan="1">
          <i class="fas fa-weight-hanging text-yellow-500"></i> Total
        </td>
        <td class="border px-2 py-1 whitespace-nowrap" colspan="1">
          {{ "{:,}".format(total_bibit).replace(',', '.') }} ekor
        </td>
        <td class="border px-2 py-1 whitespace-nowrap" colspan="1">
          {{ "{:,.2f}".format(total_berat).replace(',', '.') }} kg
        </td>
        <td class="border px-2 py-1 whitespace-nowrap" colspan="5"></td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Modal Edit Bibit -->
<div
  id="editModal"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
>
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6 relative">
    <h2 class="text-lg font-semibold text-blue-900 mb-4">Edit Bibit</h2>
    <form id="editForm" method="post" action="/dashboard/bibit/edit">
      <input type="hidden" name="bibit_id" id="edit_id" />
      <div class="mb-3">
        <label class="block text-sm font-medium text-blue-900">Kolam</label>
        <select
          id="edit_kolam"
          name="kolam_id"
          class="border rounded p-2 w-full focus:ring-2 focus:ring-blue-300"
        >
          {% for kolam in kolam_list %}
          <option value="{{ kolam.id }}">{{ kolam.nama_kolam }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-blue-900"
          >Ukuran Bibit</label
        >
        <select
          id="edit_ukuran"
          name="ukuran_bibit"
          class="border rounded p-2 w-full focus:ring-2 focus:ring-blue-300"
        >
          <option value="" disabled>Pilih ukuran...</option>
          {% for ukuran in ukuran_list %}
          <option value="{{ ukuran }}">{{ ukuran }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-blue-900"
          >Jumlah Bibit</label
        >
        <input
          type="number"
          id="edit_jumlah"
          name="jumlah"
          class="border rounded p-2 w-full focus:ring-2 focus:ring-blue-300"
        />
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-blue-900"
          >Total Berat (kg)</label
        >
        <input
          type="number"
          step="0.01"
          id="edit_berat"
          name="total_berat"
          class="border rounded p-2 w-full focus:ring-2 focus:ring-blue-300"
        />
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-blue-900"
          >Total Harga</label
        >
        <input
          type="number"
          step="0.01"
          id="edit_harga"
          name="total_harga"
          class="border rounded p-2 w-full focus:ring-2 focus:ring-blue-300"
        />
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-blue-900"
          >Tanggal Tebar</label
        >
        <input
          type="date"
          id="edit_tanggal"
          name="tanggal_tebar"
          class="border rounded p-2 w-full focus:ring-2 focus:ring-blue-300"
        />
      </div>
      <div class="mb-3">
        <label class="block text-sm font-medium text-blue-900">Catatan</label>
        <textarea
          id="edit_catatan"
          name="catatan"
          class="border rounded p-2 w-full focus:ring-2 focus:ring-blue-300"
        ></textarea>
      </div>
      <div class="flex justify-end gap-2">
        <button
          type="button"
          onclick="closeEditModal()"
          class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400"
        >
          Batal
        </button>
        <button
          type="submit"
          class="px-4 py-2 rounded bg-blue-500 hover:bg-blue-600 text-white"
        >
          Simpan
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Delete Bibit -->
<div
  id="deleteModal"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"
>
  <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6 relative">
    <h2 class="text-lg font-semibold text-blue-900 mb-4">Hapus Bibit?</h2>
    <form id="deleteForm" method="post" action="/dashboard/bibit/delete">
      <input type="hidden" name="bibit_id" id="delete_id" />
      <div class="flex justify-end gap-2">
        <button
          type="button"
          onclick="closeDeleteModal()"
          class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400"
        >
          Batal
        </button>
        <button
          type="submit"
          class="px-4 py-2 rounded bg-red-500 hover:bg-red-600 text-white"
        >
          Hapus
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  function openEditModal(
    id,
    kolam_id,
    ukuran,
    jumlah,
    harga,
    tanggal,
    catatan,
    total_berat
  ) {
    document.getElementById("edit_id").value = id;
    document.getElementById("edit_kolam").value = kolam_id;
    document.getElementById("edit_ukuran").value = ukuran;
    document.getElementById("edit_jumlah").value = jumlah;
    document.getElementById("edit_harga").value = harga;
    document.getElementById("edit_tanggal").value = tanggal;
    document.getElementById("edit_catatan").value = catatan;
    document.getElementById("edit_berat").value = total_berat;
    document.getElementById("editModal").classList.remove("hidden");
  }
  function closeEditModal() {
    document.getElementById("editModal").classList.add("hidden");
  }
  function openDeleteModal(id) {
    document.getElementById("delete_id").value = id;
    document.getElementById("deleteModal").classList.remove("hidden");
  }
  function closeDeleteModal() {
    document.getElementById("deleteModal").classList.add("hidden");
  }

  // Set default tanggal tebar ke hari ini saat halaman load
  document.addEventListener("DOMContentLoaded", () => {
    const tebarInput = document.getElementById("tanggal_tebar");
    if (tebarInput && !tebarInput.value) {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      tebarInput.value = `${yyyy}-${mm}-${dd}`;
    }
  });

  // Pagination
  const rowsPerPage = 5;
  let currentPage = 1;
  const bibitRows = document.querySelectorAll("table tbody tr");
  const totalRows = bibitRows.length;
  const totalPages = Math.ceil(totalRows / rowsPerPage);

  function showPage(page) {
    const startIdx = (page - 1) * rowsPerPage;
    const endIdx = startIdx + rowsPerPage;
    bibitRows.forEach((row, index) => {
      row.style.display = index >= startIdx && index < endIdx ? "" : "none";
    });
    document.getElementById(
      "pageInfo"
    ).innerText = `Page ${page} of ${totalPages}`;
    document.getElementById("prevBtn").disabled = page === 1;
    document.getElementById("nextBtn").disabled = page === totalPages;
  }
  function changePage(direction) {
    if (direction === "prev" && currentPage > 1) currentPage--;
    else if (direction === "next" && currentPage < totalPages) currentPage++;
    showPage(currentPage);
  }
  showPage(currentPage);
</script>
<script>
  function formatRibuan(value) {
    return value.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  }

  function angkaMurni(value) {
    return value.replace(/\./g, '');
  }

  function handleInputRibuan(input) {
    input.addEventListener('input', () => {
      let value = input.value.replace(/[^0-9]/g, '');
      input.value = value ? formatRibuan(value) : '';
    });
  }

  function handleInputDesimal(input) {
    input.addEventListener('input', () => {
      let value = input.value.replace(/[^0-9,]/g, '');

      // Cegah koma lebih dari satu
      const parts = value.split(',');
      if (parts.length > 2) {
        value = parts[0] + ',' + parts[1];
      }

      // Format bagian integer
      parts[0] = formatRibuan(parts[0]);

      input.value = parts.join(',');
    });
  }

  const form = document.querySelector('form[action="/dashboard/bibit"]');

  const jumlahInput = document.getElementById('jumlah');
  const beratInput = document.getElementById('total_berat');
  const hargaInput = document.getElementById('total_harga');

  handleInputRibuan(jumlahInput);
  handleInputDesimal(beratInput);
  handleInputRibuan(hargaInput);

  // Sebelum submit → kirim angka murni ke backend
  form.addEventListener('submit', () => {
    jumlahInput.value = angkaMurni(jumlahInput.value);
    hargaInput.value = angkaMurni(hargaInput.value);

    // desimal: 1.234,56 → 1234.56
    if (beratInput.value) {
      beratInput.value = beratInput.value
        .replace(/\./g, '')
        .replace(',', '.');
    }
  });
</script>

{% endblock %}
