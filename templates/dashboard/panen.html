<!-- templates/dashboard/panen.html -->
{% extends "dashboard/base.html" %}
{% block title %}Panen - LeleFarm{% endblock %}
{% block content %}

<!-- ===== PAGE HEADER ===== -->
<div class="mb-8 mt-5">
  <nav class="text-sm text-gray-500 mb-2">
    <ol class="flex items-center space-x-2">
      <li class="hover:text-blue-600">
        <i class="fas fa-home mr-1"></i> Dashboard
      </li>
      <li>/</li>
      <li class="text-blue-700 font-semibold">Panen</li>
    </ol>
  </nav>

  <div class="flex items-center gap-4 bg-gradient-to-r from-green-500 to-green-500 text-white p-5 rounded-2xl shadow-lg">
    <div class="bg-white/20 p-3 rounded-xl">
      <i class="fas fa-boxes text-2xl"></i>
    </div>
    <div>
      <h1 class="text-2xl font-bold leading-tight">Data Panen Kolam</h1>
      <p class="text-sm text-green-100">Rekapitulasi hasil panen per kolam</p>
    </div>
  </div>
</div>

<!-- ===== SUMMARY CARDS ===== -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
  <div class="bg-white rounded-2xl shadow p-5 border border-gray-100">
    <h3 class="text-sm font-semibold text-gray-700 mb-2">Total Panen</h3>
    <p class="text-2xl font-bold text-green-600">{{ total_ikan_global }} Ekor</p>
    <p class="text-sm text-gray-500">{{ total_berat_global }} kg</p>
  </div>
  <div class="bg-white rounded-2xl shadow p-5 border border-gray-100">
    <h3 class="text-sm font-semibold text-gray-700 mb-2">Rata-rata Berat</h3>
    <p class="text-2xl font-bold text-green-600">{{ rata_rata_berat }} kg/ekor</p>
    <p class="text-sm text-gray-500 mt-1">Dihitung dari total panen</p>
  </div>
  <div class="bg-white rounded-2xl shadow p-5 border border-gray-100">
    <h3 class="text-sm font-semibold text-gray-700 mb-2">Kolam Panen</h3>
    <p class="text-2xl font-bold text-green-600">{{ total_kolam_panen }} Kolam</p>
  </div>
  <div class="bg-gradient-to-br from-green-500 to-green-700 text-white rounded-2xl shadow-lg p-5">
    <h3 class="text-sm font-semibold mb-2">Total Nilai Panen</h3>
    <p class="text-3xl font-extrabold">Rp {{ total_jual_global }}</p>
  </div>
</div>

<!-- ===== DETAIL PER KOLAM ===== -->
{% for kolam in ringkasan_per_kolam %}
<div class="mb-6 border rounded-2xl shadow p-4 bg-white">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-lg font-bold text-gray-800">{{ kolam.nama_kolam }}</h2>
    <span class="px-3 py-1 rounded-full text-sm font-semibold {% if kolam.status_panen == 'belum' %}bg-red-200 text-red-800{% else %}bg-green-200 text-green-800{% endif %}">
      {{ kolam.status_panen|capitalize }}
    </span>
  </div>

  <div class="overflow-x-auto rounded-lg shadow ring-1 ring-black/5">
    <table class="w-full table-auto text-sm text-gray-700 text-center">
      <thead class="bg-green-500 text-white">
        <tr>
          <th class="px-4 py-2">No</th>
          <th class="px-4 py-2">Tanggal Panen</th>
          <th class="px-4 py-2">Jumlah Ekor</th>
          <th class="px-4 py-2">Total Berat (kg)</th>
          <th class="px-4 py-2">Total Jual (Rp)</th>
          <th class="px-4 py-2">Catatan</th>
          <th class="px-4 py-2">Aksi</th>
        </tr>
      </thead>
      <tbody>
        {% for p in kolam.panen_detail %}
        <tr class="hover:bg-green-50 transition">
          <td class="px-4 py-2">{{ loop.index }}</td>
          <td class="px-4 py-2">{{ p.tanggal_panen }}</td>
          <td class="px-4 py-2">{{ p.jumlah_ikan }} Ekor</td>
          <td class="px-4 py-2">{{ p.total_berat }} kg</td>
          <td class="px-4 py-2">Rp {{ p.total_jual }}</td>
          <td class="px-4 py-2">{{ p.catatan }}</td>
          <td class="px-4 py-2 flex justify-center gap-2">
            <!-- tombol Edit -->
            <button type="button" class="bg-yellow-400 text-white px-2 py-1 rounded hover:bg-yellow-500"
                    onclick="openEditModal(
                        '{{ p.id }}', 
                        '{{ p.jumlah_ikan }}', 
                        '{{ p.total_berat }}', 
                        '{{ p.total_jual }}',
                        '{{ p.tanggal_panen[:10] }}',  <!-- ambil YYYY-MM-DD -->
                        '{{ p.catatan }}'
                    )">
              Edit
            </button>
            

          </td>
        </tr>
        {% else %}
        <tr>
          <td class="px-4 py-2" colspan="7">Belum ada panen</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot class="bg-green-50 font-semibold">
        <tr>
          <td colspan="2">TOTAL</td>
          <td>{{ kolam.total_ikan_fmt }} Ekor</td>
          <td>{{ kolam.total_berat_fmt }} kg</td>
          <td>Rp {{ kolam.total_jual_fmt }}</td>
          <td colspan="2"></td>
        </tr>
      </tfoot>
      
      
      
      
    </table>
  </div>
</div>
{% endfor %}

<!-- ===== MODAL EDIT PANEN ===== -->
<div id="editModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-lg w-96 p-5">
    <h3 class="text-lg font-bold mb-4">Edit Panen</h3>
    <form id="editForm" method="post" action="/dashboard/panen/edit">
      <input type="hidden" name="panen_id" id="edit_panen_id">
      
      <div class="mb-3">
        <label class="block text-sm font-medium mb-1">Jumlah Ikan</label>
        <input type="number" name="jumlah_ikan" id="edit_jumlah_ikan" class="w-full border rounded px-2 py-1" required>
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium mb-1">Total Berat (kg)</label>
        <input type="number" step="0.01" name="total_berat" id="edit_total_berat" class="w-full border rounded px-2 py-1" required>
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium mb-1">Total Jual (Rp)</label>
        <input type="number" name="total_jual" id="edit_total_jual" class="w-full border rounded px-2 py-1" required>
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium mb-1">Tanggal Panen</label>
        <input type="date" name="tanggal_panen" id="edit_tanggal_panen" class="w-full border rounded px-2 py-1" required>
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium mb-1">Catatan</label>
        <textarea name="catatan" id="edit_catatan" class="w-full border rounded px-2 py-1"></textarea>
      </div>

      <div class="flex justify-end gap-2">
        <button type="button" class="bg-gray-300 px-3 py-1 rounded hover:bg-gray-400" onclick="closeEditModal()">Batal</button>
        <button type="submit" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">Simpan</button>
      </div>
    </form>
  </div>
</div>

<script>
    function openEditModal(id, jumlah, berat, total_jual, tanggal, catatan) {
        document.getElementById('edit_panen_id').value = id;
        document.getElementById('edit_jumlah_ikan').value = jumlah;
        document.getElementById('edit_total_berat').value = berat;
        
        // Hapus titik ribuan sebelum assign ke input number
        let totalJualClean = total_jual.toString().replace(/\./g, '');
        document.getElementById('edit_total_jual').value = totalJualClean;
    
        document.getElementById('edit_tanggal_panen').value = tanggal;
        document.getElementById('edit_catatan').value = catatan;
        document.getElementById('editModal').classList.remove('hidden');
        document.getElementById('editModal').classList.add('flex');
    }
    

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
    document.getElementById('editModal').classList.remove('flex');
}
</script>


{% endblock %}
