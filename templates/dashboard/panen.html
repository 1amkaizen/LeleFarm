<!-- templates/dashboard/panen.html -->
{% extends "dashboard/base.html" %}
{% block title %}Panen - LeleFarm{% endblock %}
{% block content %}

<!-- ===== PAGE HEADER ===== -->
<div class="mb-8 mt-5">
  <nav class="text-sm text-gray-500 mb-2">
    <ol class="flex items-center space-x-2">
      <li class="hover:text-blue-600">
        <i class="fas fa-home mr-1"></i> Dashboard
      </li>
      <li>/</li>
      <li class="text-blue-700 font-semibold">Panen</li>
    </ol>
  </nav>

  <div class="flex items-center gap-4 bg-gradient-to-r from-green-500 to-green-500 text-white p-5 rounded-2xl shadow-lg">
    <div class="bg-white/20 p-3 rounded-xl">
      <i class="fas fa-boxes text-2xl"></i>
    </div>
    <div>
      <h1 class="text-2xl font-bold leading-tight">Data Panen Kolam</h1>
      <p class="text-sm text-green-100">Rekapitulasi hasil panen per kolam</p>
    </div>
  </div>
</div>

<!-- ===== SECTION HEADER ===== -->
<div class="mb-5">
  <div class="flex items-center gap-3">
    <span class="w-1.5 h-8 bg-blue-500 rounded-full"></span>
    <div>
      <h2 class="text-xl font-bold text-gray-800">
        Ringkasan Total Panen Semua Kolam
      </h2>
      <p class="text-sm text-gray-500">
        Akumulasi panen per kolam
      </p>
    </div>
  </div>
</div>
<!-- ===== SUMMARY CARDS ===== -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">

  <!-- Total Panen -->
  <div class="bg-white rounded-2xl shadow p-5 border border-gray-100">
    <h3 class="text-sm font-semibold text-gray-700 mb-2">Total Panen</h3>
    <p class="text-2xl font-bold text-green-600">{{ total_berat_global }}</p>
</div>

  <!-- Kolam Panen -->
  <div class="bg-white rounded-2xl shadow p-5 border border-gray-100">
    <h3 class="text-sm font-semibold text-gray-700 mb-2">Kolam Panen</h3>
    <p class="text-2xl font-bold text-green-600">{{ total_kolam_panen }} Kolam</p>
  </div>

  <!-- Total Nilai Panen -->
  <div class="bg-gradient-to-br from-green-500 to-green-700 text-white rounded-2xl shadow-lg p-5">
    <h3 class="text-sm font-semibold mb-2">Total Nilai Panen</h3>
    <p class="text-3xl font-extrabold">Rp {{ total_jual_global }}</p>
  </div>

</div>


<!-- ===== SECTION HEADER ===== -->
<div class="mb-5">
  <div class="flex items-center gap-3">
    <span class="w-1.5 h-8 bg-blue-500 rounded-full"></span>
    <div>
      <h2 class="text-xl font-bold text-gray-800">
        Ringkasan Total Kolam
      </h2>
      <p class="text-sm text-gray-500">
        Akumulasi panen 
      </p>
    </div>
  </div>
</div>


<!-- templates/dashboard/panen.html -->
<!-- ===== TABEL SATU UNTUK SEMUA KOLAM ===== -->
<div class="overflow-x-auto rounded-xl shadow-lg ring-1 ring-gray-200">
    <table class="w-full min-w-max table-auto text-sm text-gray-700 text-center">
        <thead class="bg-green-600 text-white sticky top-0">
            <tr>
                <th class="px-3 py-3 font-semibold text-xs uppercase tracking-wider">No</th>
                <th class="px-3 py-3 font-semibold text-xs uppercase tracking-wider">Kolam</th>
                <th class="px-3 py-3 font-semibold text-xs uppercase tracking-wider">Tgl Panen</th>
                <th class="px-3 py-3 font-semibold text-xs uppercase tracking-wider">Tgl Tebar</th>
                <th class="px-3 py-3 font-semibold text-xs uppercase tracking-wider">Umur</th>
                <th class="px-3 py-3 font-semibold text-xs uppercase tracking-wider">Total Panen</th>
                <th class="px-3 py-3 font-semibold text-xs uppercase tracking-wider">Total Jual</th>
                <th class="px-3 py-3 font-semibold text-xs uppercase tracking-wider">Bibit</th>
                <th class="px-3 py-3 font-semibold text-xs uppercase tracking-wider">Berat Bibit</th>
                <th class="px-3 py-3 font-semibold text-xs uppercase tracking-wider">Kematian</th>
                <th class="px-3 py-3 font-semibold text-xs uppercase tracking-wider">Pengeluaran</th>
                <th class="px-3 py-3 font-semibold text-xs uppercase tracking-wider max-w-[150px]">Catatan</th>
                <th class="px-3 py-3 font-semibold text-xs uppercase tracking-wider">Aksi</th>
            </tr>
        </thead>

        <tbody>
            {% set counter = 1 %}
            {% for kolam in ringkasan_per_kolam %}
                {% for p in kolam.panen_detail %}
                <tr class="border-b last:border-b-0 hover:bg-green-50 transition duration-150">
                    <td class="px-3 py-2.5 font-medium">{{ counter }}</td>
                    <td class="px-3 py-2.5">{{ kolam.nama_kolam }}</td>
                    <td class="px-3 py-2.5">{{ p.tanggal_panen }}</td>
                    <td class="px-3 py-2.5">{{ kolam.tanggal_tebar }}</td>
                    <td class="px-3 py-2.5 font-semibold">{{ kolam.hari_aktif }} Hari</td>
                    <td class="px-3 py-2.5 text-green-700 font-bold">{{ p.total_berat }}</td>
                    <td class="px-3 py-2.5 text-green-700 font-bold">Rp {{ p.total_jual }}</td>
                    <td class="px-3 py-2.5">{{ kolam.total_ekor_bibit_fmt }} ekor</td>
                    <td class="px-3 py-2.5">{{ kolam.total_berat_bibit_fmt }}</td>
                    <td class="px-3 py-2.5">{{ kolam.total_kematian_fmt }} ekor</td>
                    <td class="px-3 py-2.5">Rp {{ kolam.total_pengeluaran_fmt }}</td>
                    <td class="px-3 py-2.5 text-left max-w-[150px] truncate" title="{{ p.catatan }}">{{ p.catatan }}</td>
                    <td class="px-3 py-2.5">
                        <button
                            type="button"
                            class="bg-yellow-500 text-white text-xs px-3 py-1.5 rounded-lg shadow-md hover:bg-yellow-600 transition duration-150 whitespace-nowrap"
                            onclick="openEditModal(
                              '{{ p.id }}',
                              '{{ p.total_berat }}',
                              '{{ p.total_jual }}',
                              '{{ p.tanggal_panen[:10] }}',
                              '{{ p.catatan|default('') }}'
                            )"
                        >
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                    </td>
                </tr>
                {% set counter = counter + 1 %}
                {% endfor %}
            {% else %}
            <tr>
                <td class="px-3 py-4 text-center text-gray-500 bg-gray-50" colspan="13">Belum ada panen tercatat.</td>
            </tr>
            {% endfor %}
        </tbody>

        <tfoot class="bg-green-50 font-extrabold text-center border-t-4 border-green-200">
            <tr>
                <td class="px-3 py-3 text-sm text-gray-800" colspan="4">TOTAL KESELURUHAN</td>
                <td class="px-3 py-3 text-sm text-green-800">{{ ringkasan_per_kolam|sum(attribute='hari_aktif') }} Hari</td>
                <td class="px-3 py-3 text-sm text-green-800">{{ "%.0f"|format(ringkasan_per_kolam|sum(attribute='total_berat'))|replace(',', '.') }}</td>
                <td class="px-3 py-3 text-sm text-green-800">Rp {{ "{:,.0f}".format(ringkasan_per_kolam|sum(attribute='total_jual'))|replace(',', '.') }}</td>
                <td class="px-3 py-3 text-sm text-gray-800">{{ ringkasan_per_kolam|sum(attribute='total_ekor_bibit')|replace(',', '.') }} ekor</td>
                <td class="px-3 py-3 text-sm text-gray-800">{{ "%.0f"|format(ringkasan_per_kolam|sum(attribute='total_berat_bibit'))|replace(',', '.') }}</td>
                <td class="px-3 py-3 text-sm text-gray-800">{{ ringkasan_per_kolam|sum(attribute='total_kematian')|replace(',', '.') }} ekor</td>
                <td class="px-3 py-3 text-sm text-gray-800">Rp {{ "{:,.0f}".format(ringkasan_per_kolam|sum(attribute='total_pengeluaran'))|replace(',', '.') }}</td>
                
                <td class="px-3 py-3" colspan="2"></td>
            </tr>
        </tfoot>
    </table>
</div>



<!-- ===== SECTION HEADER ===== -->
<div class="mb-6 mt-4">
  <div class="flex items-center gap-3">
    <span class="w-1.5 h-8 bg-blue-500 rounded-full"></span>
    <div>
      <h2 class="text-2xl font-bold text-gray-900">
        Ringkasan Panen Kolam
      </h2>
      <p class="text-sm text-gray-500">
        Rekapitulasi data panen, biaya, dan performa tiap kolam
      </p>
    </div>
  </div>
</div>



<!-- templates/dashboard/kolam_pagination.html -->
<div id="kolam-container">
    {% for kolam in ringkasan_per_kolam %}
    <div class="kolam-item mb-4 p-5 bg-white rounded-xl shadow-lg ring-1 ring-gray-100 transition duration-300 hover:shadow-xl" {% if not loop.first %}style="display:none"{% endif %}>
        <!-- ===== DETAIL KOLAM ===== -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-3 mb-3 border-gray-100">
            <h2 class="text-xl font-extrabold text-gray-800 tracking-tight break-words">{{ kolam.nama_kolam }}</h2>
            <span class="mt-2 sm:mt-0 px-3 py-1 text-sm font-bold rounded-full
                {% if kolam.status_panen == 'belum' %}
                    bg-red-500 text-white shadow-md
                {% else %}
                    bg-green-500 text-white shadow-md
                {% endif %}
            ">
                {{ kolam.status_panen|capitalize }}
            </span>
        </div>

        <!-- === BAGIAN PRODUKSI & BIAYA === -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 text-sm">
            <div class="col-span-1 sm:col-span-2 border-b pb-2 mb-2">
                <h3 class="font-bold text-gray-600 mb-1">Produksi & Biaya Awal</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-1 gap-x-4">
                    <div class="text-gray-700 break-words">
                        <i class="fas fa-fish text-blue-500 mr-2"></i>Jml Bibit: <span class="font-semibold text-blue-800">{{ kolam.total_ekor_bibit_fmt }} Ekor</span>
                    </div>
                    <div class="text-gray-700 break-words">
                        <i class="fas fa-money-bill-wave text-blue-500 mr-2"></i>Biaya Bibit: <span class="font-semibold text-blue-800">Rp {{ kolam.total_biaya_bibit_fmt }}</span>
                    </div>
                    <div class="text-gray-700 break-words">
                        <i class="fas fa-boxes text-yellow-600 mr-2"></i>Total Pakan: <span class="font-semibold text-yellow-800">{{ kolam.total_pakan_kg_fmt }}</span>
                    </div>
                    <div class="text-gray-700 break-words">
                        <i class="fas fa-money-bill-wave text-yellow-600 mr-2"></i>Biaya Pakan: <span class="font-semibold text-yellow-800">Rp {{ kolam.total_biaya_pakan_fmt }}</span>
                    </div>
                </div>
            </div>

            <div class="col-span-1 sm:col-span-2 border-b pb-2 mb-2">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-1 gap-x-4">
                    <div class="text-gray-700 col-span-1 break-words">
                        <i class="fas fa-wrench text-gray-500 mr-2"></i>Operasional Lain: <span class="font-semibold">Rp {{ kolam.total_operasional_fmt }}</span>
                    </div>
                    <div class="col-span-1 text-right bg-yellow-50 p-1 rounded-md break-words">
                        <span class="font-bold text-base text-yellow-800">Total Biaya Produksi:</span>
                        <span class="font-extrabold text-base text-yellow-800 ml-1">Rp {{ kolam.total_biaya_produksi_fmt }}</span>
                    </div>
                </div>
            </div>

            <!-- BAGIAN PANEN & PENJUALAN -->
            <div class="col-span-1 sm:col-span-2 border-b pb-2 mb-2">
                <h3 class="font-bold text-gray-600 mb-1">Panen & Penjualan</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-y-1 gap-x-4">
                    <div class="text-gray-700 break-words">
                        <i class="fas fa-calendar-alt text-teal-500 mr-2"></i>Tebar: <span class="font-semibold">{{ kolam.tanggal_tebar }}</span>
                    </div>
                    <div class="text-gray-700 break-words">
                        <i class="fas fa-calendar-check text-teal-500 mr-2"></i>Panen Terakhir: <span class="font-semibold">{{ kolam.panen_detail[-1].tanggal_panen if kolam.panen_detail|length > 0 else '-' }}</span>
                    </div>
                    <div class="text-gray-700 break-words">
                        <i class="fas fa-clock text-teal-500 mr-2"></i>Umur Panen: <span class="font-bold text-teal-700">{{ kolam.hari_aktif }} Hari</span>
                    </div>
                    <div class="text-gray-700 break-words">
                        <i class="fas fa-weight-hanging text-teal-500 mr-2"></i>Total Berat Panen: <span class="font-bold text-lg text-blue-700">{{ kolam.total_berat_fmt }}</span>
                    </div>
                    <div class="col-span-1 sm:col-span-2 text-right pt-1 break-words">
                        <span class="font-bold text-lg text-blue-700">Total Penjualan:</span>
                        <span class="font-extrabold text-2xl text-blue-700 ml-2">Rp {{ kolam.total_jual_fmt }}</span>
                    </div>
                </div>
            </div>

            <!-- BAGIAN KEUNTUNGAN / KERUGIAN -->
            <div class="col-span-1 sm:col-span-2">
                <h3 class="font-bold text-gray-600 mb-1">Total Keuntungan / Kerugian</h3>
                <div class="p-2 rounded-lg 
                    {% if kolam.total_keuntungan < 0 %}
                        bg-red-100 border border-red-300
                    {% else %}
                        bg-green-100 border border-green-300
                    {% endif %}
                    break-words
                ">
                    <span class="font-extrabold text-xl 
                        {% if kolam.total_keuntungan < 0 %}text-red-700{% else %}text-green-700{% endif %}
                    ">
                        Rp {{ kolam.total_keuntungan_fmt }}
                    </span>
                </div>
            </div>
            
    </div>
    {% endfor %}
</div>

<!-- ===== PAGINATION BUTTONS MODERN ===== -->
<div class="flex justify-center mt-4 gap-3 mb-5">
    <button id="prevBtn" class="w-10 h-10 flex items-center justify-center bg-gray-200 rounded-full hover:bg-gray-300 transition">
        <i class="fas fa-chevron-left text-gray-700"></i>
    </button>
    <button id="nextBtn" class="w-10 h-10 flex items-center justify-center bg-gray-200 rounded-full hover:bg-gray-300 transition">
        <i class="fas fa-chevron-right text-gray-700"></i>
    </button>
</div>



<!-- ===== MODAL EDIT PANEN ===== -->
<div id="editModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-lg w-96 p-5">
    <h3 class="text-lg font-bold mb-4">Edit Panen</h3>
    <form id="editForm" method="post" action="/dashboard/panen/edit">
      <input type="hidden" name="panen_id" id="edit_panen_id">
      


      <div class="mb-3">
        <label class="block text-sm font-medium mb-1">Total Berat (kg)</label>
        <input type="number" step="0.01" name="total_berat" id="edit_total_berat" class="w-full border rounded px-2 py-1" required>
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium mb-1">Total Jual (Rp)</label>
        <input type="number" name="total_jual" id="edit_total_jual" class="w-full border rounded px-2 py-1" required>
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium mb-1">Tanggal Panen</label>
        <input type="date" name="tanggal_panen" id="edit_tanggal_panen" class="w-full border rounded px-2 py-1" required>
      </div>

      <div class="mb-3">
        <label class="block text-sm font-medium mb-1">Catatan</label>
        <textarea name="catatan" id="edit_catatan" class="w-full border rounded px-2 py-1"></textarea>
      </div>

      <div class="flex justify-end gap-2">
        <button type="button" class="bg-gray-300 px-3 py-1 rounded hover:bg-gray-400" onclick="closeEditModal()">Batal</button>
        <button type="submit" class="bg-green-500 text-white px-3 py-1 rounded hover:bg-green-600">Simpan</button>
      </div>
    </form>
  </div>
</div>

<script>
  function openEditModal(id, berat, total_jual, tanggal, catatan) {
      document.getElementById('edit_panen_id').value = id;

      let beratClean = berat.toString().replace(/[^0-9.]/g, '');
      document.getElementById('edit_total_berat').value = beratClean;

      let totalJualClean = total_jual.toString().replace(/\./g, '');
      document.getElementById('edit_total_jual').value = totalJualClean;

      document.getElementById('edit_tanggal_panen').value = tanggal;
      document.getElementById('edit_catatan').value = catatan ?? '';

      const modal = document.getElementById('editModal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
  }

  function closeEditModal() {
      const modal = document.getElementById('editModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
  }
</script>

<!-- ===== JS PAGINATION ===== -->
<script>
let currentIndex = 0;
const kolamItems = document.querySelectorAll('.kolam-item');

function showKolam(index) {
    kolamItems.forEach((el, i) => {
        el.style.display = i === index ? 'block' : 'none';
    });
}

document.getElementById('prevBtn').addEventListener('click', () => {
    if(currentIndex > 0){
        currentIndex--;
        showKolam(currentIndex);
    }
});

document.getElementById('nextBtn').addEventListener('click', () => {
    if(currentIndex < kolamItems.length - 1){
        currentIndex++;
        showKolam(currentIndex);
    }
});

// inisialisasi tampilan pertama
showKolam(currentIndex);
</script>


{% endblock %}
