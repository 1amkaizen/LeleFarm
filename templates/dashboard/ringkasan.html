<!-- templates/dashboard/ringkasan.html -->
{% extends "dashboard/base.html" %} {% block title %}Ringkasan - LeleFarm{%
endblock %} {% block content %}

<!-- Header / Page title (SAMAKAN DENGAN PENGELUARAN) -->
<div class="mb-6 flex items-center gap-2 mt-5">
  <i class="fas fa-chart-pie text-green-500 text-xl"></i>
  <div>
    <h1 class="text-2xl font-semibold text-green-700 leading-tight">
      Ringkasan Pengeluaran
    </h1>
    <p class="text-sm text-green-600 mt-0.5">
      Pantau ringkasan keuangan & operasional
    </p>
  </div>
</div>

<!-- Header Total Keseluruhan -->
<div class="mb-4">
  <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
    <i class="fas fa-chart-pie text-green-500"></i> Ringkasan Total Semua Kolam
  </h2>
  <p class="text-sm text-gray-600 mt-1">
    Total pengeluaran bibit, pakan, dan operasional untuk semua kolam
  </p>
</div>
<!-- Ringkasan Total Keseluruhan Semua Kolam -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
  <!-- Bibit Card -->
  <div class="bg-white shadow rounded-lg p-4 border">
    <h3 class="text-sm font-semibold text-gray-600 flex items-center gap-2">
      <i class="fas fa-fish text-indigo-500 text-xl"></i> Pengeluaran Bibit
    </h3>
    <p class="text-2xl font-bold text-indigo-600">Rp {{ total_pengeluaran_semua_kolam.bibit.total_harga_fmt }}</p>
    <p class="text-sm text-gray-500">{{ total_pengeluaran_semua_kolam.bibit.total_item_fmt }} ekor bibit</p>
  </div>
  <!-- Pakan Card -->
  <div class="bg-white shadow rounded-lg p-4 border">
    <h3 class="text-sm font-semibold text-gray-600 flex items-center gap-2">
      <i class="fas fa-drumstick-bite text-yellow-500"></i> Pengeluaran Pakan
    </h3>
    <p class="text-2xl font-bold text-yellow-600">Rp {{ total_pengeluaran_semua_kolam.pakan.total_harga_fmt }}</p>
    <p class="text-sm text-gray-500">Total pakan {{ total_pengeluaran_semua_kolam.pakan.total_item_fmt }} kg</p>
  </div>
  <!-- Operasional Card -->
  <div class="bg-white shadow rounded-lg p-4 border">
    <h3 class="text-sm font-semibold text-gray-600 flex items-center gap-2">
      <i class="fas fa-receipt text-blue-500"></i> Operasional Lain
    </h3>
    <p class="text-2xl font-bold text-blue-600">Rp {{ total_pengeluaran_semua_kolam.operasional.total_harga_fmt }}</p>
    <p class="text-sm text-gray-500">{{ total_pengeluaran_semua_kolam.operasional.total_item_fmt }} transaksi</p>
  </div>
  <!-- Total Pengeluaran Card -->
  <div class="bg-blue-50 shadow rounded-lg p-4 border border-blue-200">
    <h3 class="text-sm font-semibold text-blue-700 flex items-center gap-2">
      <i class="fas fa-wallet"></i> Total Pengeluaran
    </h3>
    <p class="text-3xl font-bold text-blue-800">Rp {{ total_pengeluaran_semua_kolam.total_pengeluaran_fmt }}</p>
  </div>
</div>


<!-- Header Accordion Semua Kolam -->
<div class="mb-4">
  <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
    <i class="fas fa-water text-blue-500"></i> Detail Pengeluaran Per Kolam
  </h2>
  <p class="text-sm text-gray-600 mt-1">
    Klik kolam untuk melihat rincian bibit, pakan, dan operasional
  </p>
</div>
<!-- Bungkus semua accordion -->
<div id="accordion-container">
{% for kolam in pengeluaran_per_kolam %}
<div class="accordion border rounded-lg mb-4">
  <!-- Header Card Accordion -->
  <div 
    class="cursor-pointer flex justify-between items-center p-4 transition-all duration-300
           {% if kolam.status_label == 'Belum Panen' %}
           bg-red-100 to-red-200 hover:from-red-200 hover:to-red-300
           {% else %}
           bg-green-100 to-green-200 hover:from-green-200 hover:to-green-300
           {% endif %}"
    onclick="this.parentElement.querySelector('.accordion-body').classList.toggle('max-h-0'); this.querySelector('i').classList.toggle('rotate-180');"
  >
    <div class="flex items-center gap-3">
      <i class="fas fa-water {% if kolam.status_label == 'Belum Panen' %}text-red-600{% else %}text-green-600{% endif %} text-xl"></i>
      <div>
        <div class="font-semibold {% if kolam.status_label == 'Belum Panen' %}text-red-800{% else %}text-green-800{% endif %} text-lg">
          {{ kolam.nama_kolam }}
        </div>
        <div class="flex flex-col gap-0.5 text-sm">
          <div class="{% if kolam.status_label == 'Belum Panen' %}text-red-700{% else %}text-green-700{% endif %}">
            Status: {{ kolam.status_label }}
          </div>
          <div class="text-gray-600">
            Tanggal Mulai: {{ kolam.tanggal_mulai }}
          </div>
        </div>
      </div>
    </div>
    <i class="fas fa-chevron-down {% if kolam.status_label == 'Belum Panen' %}text-red-800{% else %}text-green-800{% endif %} transition-transform duration-300"></i>
  </div>
  


  <!-- Body Accordion (default hidden) -->
  <div class="accordion-body max-h-0 overflow-hidden transition-all duration-500 bg-white">
    
    <div class="p-4">

    <!-- Tabel Detail (Bibit / Pakan / Operasional) -->
    
<!-- BIBIT -->
<div class="bg-white border rounded-xl shadow-sm p-4 mb-8">
  <!-- HEADER -->
  <div class="flex items-start justify-between mb-3">
    <div>
      <h2 class="text-lg font-semibold text-indigo-700 flex items-center gap-2">
        <i class="fas fa-fish"></i>
        Pengeluaran Bibit
      </h2>
      <p class="text-sm text-gray-500">
        Rincian pembelian bibit ikan berdasarkan transaksi
      </p>
    </div>
  </div>

  <!-- Tambahkan overflow-x-auto -->
  <div class="overflow-x-auto">
    <table class="w-full table-auto border text-center paginate-bibit" data-kolam="{{ kolam.id }}">
      <thead class="bg-indigo-100 text-indigo-800">
        <tr>
          <th>No</th>
          <th>Tanggal</th>
          <th>Jenis</th>
          <th>Jumlah</th>
          <th>Total</th>
          
        </tr>
      </thead>
      <tbody>
        {% for item in kolam.bibit.detail %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ item.tanggal }}</td>
          <td>{{ item.nama }}</td>
          <td>{{ item.jumlah }} Ekor</td>
          <td>Rp {{ item.total }}</td>
          
        </tr>
        {% endfor %}
      </tbody>
      <tfoot class="bg-indigo-50 font-semibold">
        <tr>
          <td colspan="2" class="text-right">TOTAL Bibit</td>
          <td>{{ kolam.bibit.total_item_fmt }} Ekor</td>
          <td>Rp {{ kolam.bibit.total_harga_fmt }}</td>
          <td></td> 
        </tr>
      </tfoot>
      
    </table>
  </div>

  <!-- PAGINATION BIBIT-->
  <div class="flex justify-center mt-3 mb-2 space-x-2">
    <button id="prev-bibit-{{ kolam.id }}" class="prev-btn px-4 py-1 bg-indigo-500 text-white rounded disabled:bg-gray-300">‹</button>
    <span id="info-bibit-{{ kolam.id }}" class="font-semibold text-indigo-700">Page 1</span>
    <button id="next-bibit-{{ kolam.id }}" class="next-btn px-4 py-1 bg-indigo-500 text-white rounded disabled:bg-gray-300">›</button>
    
  </div>
</div>

<!-- PAKAN -->
<div class="bg-white border rounded-xl shadow-sm p-4 mb-8">
  <!-- HEADER -->
  <div class="flex items-start justify-between mb-3">
    <div>
      <h2 class="text-lg font-semibold text-yellow-700 flex items-center gap-2">
        <i class="fas fa-drumstick-bite"></i>
        Pengeluaran Pakan
      </h2>
      <p class="text-sm text-gray-500">Riwayat pembelian dan stok pakan</p>
    </div>
  </div>

  <!-- WRAP TABLE AGAR SCROLL DI MOBILE -->
  <div class="overflow-x-auto">
    <table class="w-full table-auto border text-center paginate-pakan" data-kolam="{{ kolam.id }}">
      <thead class="bg-yellow-100 text-yellow-800">
        <tr>
          <th>No</th>
          <th>Tanggal</th>
          <th>Nama</th>
          <th>Jumlah</th>
          <th>Total</th>
         
        </tr>
      </thead>
      <tbody>
        {% for item in kolam.pakan.detail %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ item.tanggal }}</td>
          <td>{{ item.nama }}</td>
          <td>{{ item.jumlah }} kg</td>
          <td>Rp {{ item.total }}</td>
          
        </tr>
        {% endfor %}
      </tbody>
      <tfoot class="bg-yellow-50 font-semibold">
        <tr>
          <td colspan="2" class="text-right">TOTAL Pakan </td>
          <td>{{ kolam.pakan.total_item_fmt }} kg</td>
          <td>Rp {{ kolam.pakan.total_harga_fmt }}</td>
          <td></td> 
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- PAGINATION PAKAN-->
  <div class="flex justify-center mt-3 mb-2 space-x-2">
    <button
     
      id="prev-pakan-{{ kolam.id }}"
      class="px-4 py-1 bg-yellow-500 text-white rounded disabled:bg-gray-300"
    >
      ‹
    </button>

    <span id="info-pakan-{{ kolam.id }}" class="font-semibold text-yellow-600">Page 1</span>

    <button
   
      id="next-pakan-{{ kolam.id }}"
      class="px-4 py-1 bg-yellow-500 text-white rounded disabled:bg-gray-300"
    >
      ›
    </button>
  </div>
</div>

<!-- OPERASIONAL -->
<div class="bg-white border rounded-xl shadow-sm p-4 mb-8">
  <!-- HEADER -->
  <div class="flex items-start justify-between mb-3">
    <div>
      <h2 class="text-lg font-semibold text-blue-700 flex items-center gap-2">
        <i class="fas fa-receipt"></i>
        Pengeluaran Operasional
      </h2>
      <p class="text-sm text-gray-500">
        Biaya operasional harian dan pendukung kolam
      </p>
    </div>
  </div>

  <!-- WRAP TABLE AGAR SCROLL DI MOBILE -->
  <div class="overflow-x-auto">
    <table class="w-full table-auto border text-center paginate-operasional" data-kolam="{{ kolam.id }}">
      <thead class="bg-blue-100 text-blue-800">
        <tr>
          <th>No</th>
          <th>Tanggal</th>
          <th>Nama</th>
          <th>Jumlah</th>
          <th>Total</th>
          
        </tr>
      </thead>
      <tbody>
        {% for item in kolam.operasional.detail %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ item.tanggal }}</td>
          <td>{{ item.nama }}</td>
          <td>{{ item.jumlah }}</td>
          <td>Rp {{ item.total }}</td>
          
        </tr>
        {% endfor %}
      </tbody>
      <tfoot class="bg-blue-50 font-semibold">
        <tr>
          <td colspan="2" class="text-right">TOTAL Operasional</td>
          <td>{{ kolam.operasional.total_item_fmt }}</td>
          <td>Rp {{ kolam.operasional.total_harga_fmt }}</td>
          <td></td> 
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- PAGINATION OPERASIONAL-->
  <div class="flex justify-center mt-3 mb-2 space-x-2">
    <button
      
      id="prev-operasional-{{ kolam.id }}"
      class="px-4 py-1 bg-blue-500 text-white rounded disabled:bg-gray-300"
    >
      ‹
    </button>

    <span id="info-operasional-{{ kolam.id }}" class="font-semibold text-blue-600">Page 1</span>

    <button
     
      id="next-operasional-{{ kolam.id }}"
      class="px-4 py-1 bg-blue-500 text-white rounded disabled:bg-gray-300"
    >
      ›
    </button>
  </div>
</div>
</div>
  </div>
</div>

{% endfor %}
</div>
<!-- Pagination Controls Accordion -->
<div class="flex justify-center mt-4 space-x-2 mb-5">
  <button id="prev-accordion" class="px-6 py-2 bg-green-500 text-white rounded-lg disabled:bg-gray-300">‹</button>
  <span id="info-accordion" class="mx-4 text-lg font-semibold">Page 1</span>
  <button id="next-accordion" class="px-6 py-2 bg-green-500 text-white rounded-lg disabled:bg-gray-300">›</button>
</div>


  
<!-- TABEL PERBANDINGAN -->
<h2 class="text-xl font-semibold mb-2 flex items-center gap-2 text-blue-700">
  <i class="fas fa-coins text-blue-500"></i> Perbandingan Pengeluaran Per Kolam
</h2>

<div class="overflow-x-auto mb-5">
  <table id="perbandingan-table" class="w-full md:min-w-[800px] table-auto border-collapse border bg-white shadow rounded-lg overflow-hidden text-center">
    <thead class="bg-blue-100 text-blue-700 font-semibold">
      <tr>
        <th class="border px-2 py-1 whitespace-nowrap">Kolam</th>
        <th class="border px-2 py-1 whitespace-nowrap">Total Pengeluaran</th>
        <th class="border px-2 py-1 whitespace-nowrap">Selisih</th>
        <th class="border px-2 py-1 whitespace-nowrap">Operasional</th>
        <th class="border px-2 py-1 whitespace-nowrap">Bibit</th>
        <th class="border px-2 py-1 whitespace-nowrap">Pakan</th>
        <th class="border px-2 py-1 whitespace-nowrap">Proporsi Terhadap Kolam Terbesar</th>
      </tr>
    </thead>
    <tbody class="divide-y divide-gray-200">
      {% for kolam in pengeluaran_per_kolam %}
      <tr class="{{ loop.cycle('bg-white', 'bg-gray-50') }}">
        <td class="border px-2 py-1 whitespace-nowrap font-semibold">{{ kolam.nama_kolam }}</td>
        <td class="border px-2 py-1 whitespace-nowrap">Rp {{ kolam.total_pengeluaran_fmt }}</td>
        <td class="border px-2 py-1 whitespace-nowrap {% if kolam.selisih_total < 0 %}text-red-600{% elif kolam.selisih_total > 0 %}text-green-600{% endif %}">
          {{ kolam.selisih_fmt }}
        </td>
        <td class="border px-2 py-1 whitespace-nowrap">{{ kolam.operasional.total_harga_fmt_with_pct }}</td>
        <td class="border px-2 py-1 whitespace-nowrap">{{ kolam.bibit.total_harga_fmt_with_pct }}</td>
        <td class="border px-2 py-1 whitespace-nowrap">{{ kolam.pakan.total_harga_fmt_with_pct }}</td>
        <td class="border px-2 py-1 whitespace-nowrap">
          <div class="flex items-center gap-2">
            <!-- Bar -->
            <div class="flex-1 h-4 bg-gray-200 rounded overflow-hidden">
              <div 
                class="h-4 rounded"
                style="
                  width: {{ kolam.proporsi_max if kolam.proporsi_max > 0 else 5 }}%;
                  {% if kolam.proporsi_max > 70 %}
                  background: linear-gradient(to right, #16a34a, #059669); /* hijau */
                  {% elif kolam.proporsi_max > 40 %}
                  background: linear-gradient(to right, #eab308, #facc15); /* kuning */
                  {% else %}
                  background: linear-gradient(to right, #dc2626, #f87171); /* merah */
                  {% endif %}
                "
              ></div>
            </div>
            <!-- Persentase di samping bar -->
            <span class="text-sm font-semibold
              {% if kolam.proporsi_max > 70 %}text-green-600
              {% elif kolam.proporsi_max > 40 %}text-yellow-600
              {% else %}text-red-600{% endif %}">
              {{ kolam.proporsi_max }}%
            </span>
          </div>
        </td>
        
        
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>


<!-- Pagination Controls -->
<div class="flex justify-center mt-4 space-x-2 mb-5">
  <button id="prev-perbandingan" class="px-6 py-2 bg-blue-500 text-white rounded-lg disabled:bg-gray-300">‹</button>
  <span id="info-perbandingan" class="mx-4 text-lg font-semibold">Page 1</span>
  <button id="next-perbandingan" class="px-6 py-2 bg-blue-500 text-white rounded-lg disabled:bg-gray-300">›</button>
</div>

<script>
  const ROWS_PER_PAGE_PERBANDINGAN = 5;
  const tablePB = document.getElementById("perbandingan-table");
  const rowsPB = Array.from(tablePB.querySelectorAll("tbody tr"));
  let pagePB = 1;
  const infoPB = document.getElementById("info-perbandingan");
  const prevPB = document.getElementById("prev-perbandingan");
  const nextPB = document.getElementById("next-perbandingan");

  const renderPB = () => {
    const totalPages = Math.ceil(rowsPB.length / ROWS_PER_PAGE_PERBANDINGAN) || 1;
    const start = (pagePB - 1) * ROWS_PER_PAGE_PERBANDINGAN;
    const end = start + ROWS_PER_PAGE_PERBANDINGAN;
    rowsPB.forEach((row, i) => row.style.display = i >= start && i < end ? "" : "none");
    infoPB.innerText = `Page ${pagePB} of ${totalPages}`;
    prevPB.disabled = pagePB === 1;
    nextPB.disabled = pagePB === totalPages;
  }

  prevPB.addEventListener("click", () => { pagePB--; renderPB(); });
  nextPB.addEventListener("click", () => { pagePB++; renderPB(); });

  renderPB();
</script>

<script>
  const ROWS_PER_PAGE = 5;
  
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("table[data-kolam]").forEach((tableEl) => {
      const kolamId = tableEl.dataset.kolam;
      const type = tableEl.classList.contains("paginate-bibit")
        ? "bibit"
        : tableEl.classList.contains("paginate-pakan")
        ? "pakan"
        : "operasional";
  
      const rows = Array.from(tableEl.querySelectorAll("tbody tr"));
      let page = 1; // page per tabel
  
      const infoEl = document.getElementById(`info-${type}-${kolamId}`);
      const prevBtn = document.getElementById(`prev-${type}-${kolamId}`);
      const nextBtn = document.getElementById(`next-${type}-${kolamId}`);
  
      const render = () => {
        const totalPages = Math.ceil(rows.length / ROWS_PER_PAGE) || 1;
        const start = (page - 1) * ROWS_PER_PAGE;
        const end = start + ROWS_PER_PAGE;
  
        rows.forEach((row, i) => {
          row.style.display = i >= start && i < end ? "" : "none";
        });
  
        infoEl.innerText = `Page ${page} of ${totalPages}`;
        prevBtn.disabled = page === 1;
        nextBtn.disabled = page === totalPages;
      };
  
      // Pakai addEventListener supaya tidak overwrite loop lain
      prevBtn.addEventListener("click", () => {
        page = Math.max(1, page - 1);
        render();
      });
  
      nextBtn.addEventListener("click", () => {
        const totalPages = Math.ceil(rows.length / ROWS_PER_PAGE) || 1;
        page = Math.min(totalPages, page + 1);
        render();
      });
  
      render(); // render pertama kali
    });
  });
  </script>
  
  <script>
    const ACCORDIONS_PER_PAGE = 2; // accordion per page
    const accordionContainer = document.getElementById("accordion-container");
    const accordions = Array.from(accordionContainer.querySelectorAll(".accordion"));
    let accordionPage = 1;
    const infoAccordion = document.getElementById("info-accordion");
    const prevAccordion = document.getElementById("prev-accordion");
    const nextAccordion = document.getElementById("next-accordion");
    
    const renderAccordion = () => {
      const totalPages = Math.ceil(accordions.length / ACCORDIONS_PER_PAGE) || 1;
      const start = (accordionPage - 1) * ACCORDIONS_PER_PAGE;
      const end = start + ACCORDIONS_PER_PAGE;
      accordions.forEach((acc, i) => acc.style.display = i >= start && i < end ? "" : "none");
      infoAccordion.innerText = `Page ${accordionPage} of ${totalPages}`;
      prevAccordion.disabled = accordionPage === 1;
      nextAccordion.disabled = accordionPage === totalPages;
    };
    
    prevAccordion.addEventListener("click", () => { accordionPage--; renderAccordion(); });
    nextAccordion.addEventListener("click", () => { accordionPage++; renderAccordion(); });
    
    renderAccordion();
    </script>
{% endblock %}
